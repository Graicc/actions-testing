name: Build
description: Builds mod

runs:
  using: "composite"
  steps:
  # Get working dir
  - name: Get working directory
    id: wd
    uses: Graicc/actions-testing/.github/actions/working-dir@main

    # Download required libraries
  - name: Download Stripped Libs
    uses: robinraju/release-downloader@v1.2
    with:
      repository: "Gorilla-Tag-Modding-Group/BeatStripper"
      latest: true
      fileName: "Stripped.zip"
  - name: Extract Stripped Libs
    shell: pwsh
    run: Expand-Archive .\Stripped.zip ${{steps.wd.outputs.dir}}\Libs
  - name: Download BepInEx
    uses: robinraju/release-downloader@v1.2
    with:
      repository: "BepInEx/BepInEx"
      latest: true
      fileName: "*"
  - name: Extract BepInEx
    shell: pwsh
    run: |
      Expand-Archive BepInEx_x64*.zip Temp
      cp Temp\BepInEx\core\*.dll ${{ steps.wd.outputs.dir }}\Libs
      rm Temp -Recurse

  - uses: Graicc/actions-testing/.github/actions/deps/legoandmars/Utilla@main
    with:
      output-dir: ${{ steps.wd.outputs.dir }}\Libs

    # Build the mod
  - name: Setup dotnet
    uses: actions/setup-dotnet@v1
  - name: Build project
    env: 
      CI: TRUE
    shell: pwsh
    run: ${{ steps.wd.outputs.dir }}\MakeRelease.ps1
  - name: Prepare build for upload
    shell: pwsh
    run: | # TODO: this could break
      $dir = (ls . -filter *.csproj -recurse).BaseName
      mv $dir\$dir-v.zip Build.zip